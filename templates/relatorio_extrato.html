{% extends "base.html" %}

{% block title %}Extrato Banc√°rio Completo{% endblock %}

{% block content %}
<div class="page-header">
    <div class="breadcrumb">
        <a href="{{ url_for('dashboard') }}">üìä Dashboard</a> / <span>Extrato Banc√°rio</span>
    </div>
    <h1>Extrato Banc√°rio Completo</h1>
    <p>Movimenta√ß√µes consolidadas: receitas, despesas e transfer√™ncias</p>
</div>

<!-- FILTROS -->
<div class="card">
    <div class="card-title">Filtros de Pesquisa</div>
    
    <form method="GET">
        <div class="form-grid cols-4">
            <div class="form-group" style="margin-bottom: 0;">
                <label>Conta Banc√°ria:*</label>
                <select name="instituicao_id" id="filter_instituicao_id" required onchange="this.form.submit()">
                    <option value="">-- Selecione uma conta --</option>
                    {% for inst in instituicoes %}
                    <option value="{{ inst.id }}" {% if inst.id == instituicao_id %}selected{% endif %}>
                        {{ inst.descricao }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Data In√≠cio:</label>
                <input type="date" name="data_inicio" id="filter_data_inicio" value="{{ data_inicio or '' }}">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Data Fim:</label>
                <input type="date" name="data_fim" id="filter_data_fim" value="{{ data_fim or '' }}">
            </div>
            <button type="submit" class="btn btn-primary" style="align-self: end;">Filtrar</button>
        </div>
    </form>
    
    <!-- BOT√ïES DE EXPORTA√á√ÉO -->
    {% if instituicao_selecionada %}
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">
                üì• Exportar Extrato
            </h3>
            <span style="font-size: 12px; color: #64748b;">
                Conta: <strong>{{ instituicao_selecionada }}</strong> | 
                {{ movimentacoes|length }} movimenta√ß√£o(√µes)
            </span>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
            <!-- Exportar Excel -->
            <button onclick="exportarExtrato('excel')" class="btn btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 18px;">üìä</span>
                <span>Exportar Excel Formatado</span>
            </button>
            
            <!-- Exportar CSV -->
            <button onclick="exportarExtrato('csv')" class="btn btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 18px;">üìÑ</span>
                <span>Exportar CSV</span>
            </button>
        </div>
        
        <div class="alert alert-info" style="margin-top: 15px; padding: 12px;">
            <strong>‚ÑπÔ∏è Sobre a Exporta√ß√£o do Extrato:</strong>
            <ul style="margin: 8px 0 0 20px; font-size: 13px;">
                <li><strong>Excel Formatado:</strong> Inclui cabe√ßalho com dados da conta, resumo financeiro (saldo inicial, entradas, sa√≠das, saldo final) e tabela completa com cores por tipo de opera√ß√£o</li>
                <li><strong>CSV:</strong> Formato texto com todos os dados do extrato - ideal para importar em outras ferramentas</li>
                <li><strong>Saldo Inicial:</strong> Calculado automaticamente com base em todas as movimenta√ß√µes anteriores ao per√≠odo selecionado</li>
                <li><strong>Saldo Progressivo:</strong> Mostra o saldo ap√≥s cada movimenta√ß√£o</li>
                <li>Os filtros de data aplicados acima ser√£o respeitados na exporta√ß√£o</li>
            </ul>
        </div>
    </div>
    {% endif %}
</div>

{% if instituicao_selecionada %}
<!-- RESUMO DO EXTRATO -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 600;">SALDO INICIAL</div>
        <div style="font-size: 28px; font-weight: 700; color: {% if saldo_inicial >= 0 %}#10b981{% else %}#ef4444{% endif %}; margin-bottom: 8px;">
            {{ format_brl(saldo_inicial) }}
        </div>
        <div style="font-size: 13px; color: #64748b;">
            {% if data_inicio %}
                At√© {{ (data_inicio|replace('-', '/')) }}
            {% else %}
                In√≠cio dos registros
            {% endif %}
        </div>
    </div>

    <div class="card" style="background: #f0fdf4; border-left: 4px solid #10b981;">
        <div style="font-size: 13px; color: #065f46; margin-bottom: 8px; font-weight: 600;">ENTRADAS</div>
        <div style="font-size: 28px; font-weight: 700; color: #10b981; margin-bottom: 8px;">
            {{ format_brl(total_entradas) }}
        </div>
        <div style="font-size: 13px; color: #065f46;">Receitas + Transf. Recebidas</div>
    </div>

    <div class="card" style="background: #fef2f2; border-left: 4px solid #ef4444;">
        <div style="font-size: 13px; color: #991b1b; margin-bottom: 8px; font-weight: 600;">SA√çDAS</div>
        <div style="font-size: 28px; font-weight: 700; color: #ef4444; margin-bottom: 8px;">
            {{ format_brl(total_saidas) }}
        </div>
        <div style="font-size: 13px; color: #991b1b;">Despesas + Transf. Enviadas</div>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">SALDO FINAL</div>
        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">
            {{ format_brl(saldo_final) }}
        </div>
        <div style="font-size: 13px; opacity: 0.9;">
            {% if data_fim %}Em {{ data_fim|replace('-', '/') }}{% else %}Hoje{% endif %}
        </div>
    </div>
</div>

<!-- TABELA DE MOVIMENTA√á√ïES -->
<div class="card">
    <div class="card-title">
        Extrato: {{ instituicao_selecionada }}
        {% if data_inicio and data_fim %}
            ({{ data_inicio|replace('-', '/') }} a {{ data_fim|replace('-', '/') }})
        {% elif data_inicio %}
            (A partir de {{ data_inicio|replace('-', '/') }})
        {% elif data_fim %}
            (At√© {{ data_fim|replace('-', '/') }})
        {% else %}
            (Todas as movimenta√ß√µes)
        {% endif %}
    </div>

    {% if movimentacoes %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 10%;">Data</th>
                    <th style="width: 25%;">Descri√ß√£o</th>
                    <th style="width: 15%;">Tipo</th>
                    <th style="width: 12%;">Categoria</th>
                    <th style="width: 15%;">Detalhes</th>
                    <th style="width: 8%; text-align: center;">Comp.</th>
                    <th style="width: 10%; text-align: right;">Valor</th>
                    <th style="width: 15%; text-align: right;">Saldo</th>
                </tr>
            </thead>
            <tbody>
                <!-- Linha de Saldo Inicial -->
                <tr style="background: #f8fafc; font-weight: 600;">
                    <td colspan="6"><strong>SALDO INICIAL</strong></td>
                    <td style="text-align: right;">‚Äî</td>
                    <td style="text-align: right; color: {% if saldo_inicial >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                        <strong>{{ format_brl(saldo_inicial) }}</strong>
                    </td>
                </tr>

                <!-- Movimenta√ß√µes -->
                {% for mov in movimentacoes %}
                <tr>
                    <td>{{ mov.data_formatada }}</td>
                    <td>{{ mov.descricao }}</td>
                    <td>
                        {% if mov.tipo == 'Movimento' %}
                            <span class="badge badge-gray">{{ mov.categoria_tipo }}</span>
                        {% elif mov.tipo == 'Transfer√™ncia Recebida' %}
                            <span class="badge badge-success">‚Üì Recebida</span>
                        {% else %}
                            <span class="badge badge-warning">‚Üë Enviada</span>
                        {% endif %}
                    </td>
                    <td>{{ mov.categoria or '‚Äî' }}</td>
                    <td style="font-size: 12px; color: #64748b;">
                        {{ mov.origem_destino or '‚Äî' }}
                    </td>
                    <td style="text-align: center; font-size: 11px;">
                        {% if mov.compartilhado == '100% Silvia' %}
                            üë© S
                        {% elif mov.compartilhado == '100% Nelson' %}
                            üë® N
                        {% else %}
                            üë• 50/50
                        {% endif %}
                    </td>
                    <td style="text-align: right; font-weight: 600; color: {% if mov.valor > 0 %}#10b981{% else %}#ef4444{% endif %};">
                        {% if mov.valor > 0 %}+{% endif %}{{ format_brl(mov.valor) }}
                    </td>
                    <td style="text-align: right; font-weight: 600; color: {% if mov.saldo_apos >= 0 %}#1e293b{% else %}#ef4444{% endif %};">
                        {{ format_brl(mov.saldo_apos) }}
                    </td>
                </tr>
                {% endfor %}

                <!-- Linha de Saldo Final -->
                <tr style="background: #f8fafc; font-weight: 600; border-top: 2px solid #cbd5e1;">
                    <td colspan="6"><strong>SALDO FINAL</strong></td>
                    <td style="text-align: right;">‚Äî</td>
                    <td style="text-align: right; color: {% if saldo_final >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                        <strong>{{ format_brl(saldo_final) }}</strong>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #64748b;">
        <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
        <p>Nenhuma movimenta√ß√£o encontrada para o per√≠odo selecionado.</p>
    </div>
    {% endif %}
</div>

<!-- LEGENDA -->
<div class="alert alert-info" style="margin-top: 30px;">
    <strong>‚ÑπÔ∏è Como ler este extrato:</strong>
    <ul style="margin: 10px 0 0 20px;">
        <li><strong>Saldo Inicial:</strong> Calculado automaticamente somando TODAS as movimenta√ß√µes ANTES do per√≠odo selecionado</li>
        <li><strong>Movimentos (Receita/Despesa):</strong> Valores em verde/vermelho s√£o receitas e despesas cadastradas em "Movimentos"</li>
        <li><strong>Transfer√™ncias Recebidas:</strong> Dinheiro que ENTROU nesta conta vindo de outra conta</li>
        <li><strong>Transfer√™ncias Enviadas:</strong> Dinheiro que SAIU desta conta para outra conta ou cart√£o</li>
        <li><strong>Saldo:</strong> Mostra o saldo acumulado ap√≥s cada opera√ß√£o</li>
        <li><strong>Compartilhado:</strong> üë© = 100% Silvia | üë® = 100% Nelson | üë• = 50/50</li>
        <li><strong>Exporta√ß√£o:</strong> Use os bot√µes acima para gerar arquivos Excel ou CSV do extrato completo</li>
    </ul>
</div>

<div class="alert alert-warning" style="margin-top: 20px;">
    <strong>üí° Dica:</strong> Se voc√™ n√£o informar uma data de in√≠cio, o sistema automaticamente usa a data da primeira movimenta√ß√£o registrada nesta conta. 
    O saldo inicial ser√° sempre ZERO nesse caso. Se quiser ver um per√≠odo espec√≠fico e o saldo correto antes desse per√≠odo, 
    defina a data de in√≠cio desejada.
</div>

{% else %}
<!-- MENSAGEM INICIAL -->
<div class="card">
    <div style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 20px;">üè¶</div>
        <h3 style="color: #1e293b; margin-bottom: 10px;">Selecione uma Conta</h3>
        <p style="color: #64748b;">
            Escolha uma conta banc√°ria no filtro acima para visualizar o extrato completo<br>
            com todas as receitas, despesas e transfer√™ncias.
        </p>
    </div>
</div>
{% endif %}

<script>
    // Fun√ß√£o para exportar extrato
    function exportarExtrato(formato) {
        const instituicaoId = document.getElementById('filter_instituicao_id').value;
        
        if (!instituicaoId) {
            alert('Por favor, selecione uma conta banc√°ria primeiro.');
            return;
        }
        
        const dataInicio = document.getElementById('filter_data_inicio').value;
        const dataFim = document.getElementById('filter_data_fim').value;
        
        let url = `/relatorio/extrato/exportar?formato=${formato}&instituicao_id=${instituicaoId}`;
        
        if (dataInicio) {
            url += `&data_inicio=${dataInicio}`;
        }
        
        if (dataFim) {
            url += `&data_fim=${dataFim}`;
        }
        
        // Abre em nova aba para download
        window.location.href = url;
    }
</script>

{% endblock %}