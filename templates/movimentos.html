{% extends "base.html" %}

{% block title %}Lan√ßamento de Movimentos{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Lan√ßamento de Movimentos</h1>
        <p>Cadastro de receitas e despesas</p>
    </div>

    <!-- FORMUL√ÅRIO DE NOVO MOVIMENTO -->
    <div class="card">
        <div class="card-title">Novo Movimento</div>
        
        <form method="POST" action="{{ url_for('add_movimento') }}">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label for="data_movimento">Data do Movimento:</label><input type="date" name="data_movimento" required></div>
                <div class="form-group"><label for="data_efetivacao">Data de Efetiva√ß√£o (opcional):</label><input type="date" name="data_efetivacao"></div>
            </div>
            <div class="form-group"><label for="descricao">Descri√ß√£o:</label><input type="text" name="descricao" required autocomplete="off"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label for="categoria_id">Categoria:</label><select name="categoria_id" required><option value="">-- Selecione --</option>{% for cat in categorias %}<option value="{{ cat.id }}">{{ cat.descricao }} ({{ cat.tipo }})</option>{% endfor %}</select></div>
                <div class="form-group"><label for="instituicao_id">Conta / Banco:</label><select name="instituicao_id" required><option value="">-- Selecione --</option>{% for inst in instituicoes %}<option value="{{ inst.id }}">{{ inst.descricao }}</option>{% endfor %}</select></div>
                <div class="form-group"><label for="cartao_id">Cart√£o de Cr√©dito (opcional):</label><select name="cartao_id"><option value="">-- Nenhum --</option>{% for cartao in cartoes %}<option value="{{ cartao.id }}">{{ cartao.descricao }}</option>{% endfor %}</select></div>
            </div>
             <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group"><label for="valor">Valor (R$):</label><input type="number" name="valor" step="0.01" min="0" required placeholder="Use apenas n√∫meros positivos"></div>
                 <div class="form-group"><label for="status">Status:</label><select name="status" required><option value="Pendente">Pendente</option><option value="Efetivado">Efetivado</option></select></div>
                <div class="form-group"><label for="compartilhado">Compartilhado:</label><select name="compartilhado" required><option value="100% Silvia">100% Silvia</option><option value="100% Nelson">100% Nelson</option><option value="50/50">50/50</option></select></div>
            </div>
            <button type="submit" class="btn btn-primary">Adicionar Movimento</button>
        </form>
    </div>

    <!-- FILTROS E EXPORTA√á√ÉO -->
    <div class="card">
        <div class="card-title">Filtros e Exporta√ß√£o</div>
        
        <form method="GET" action="{{ url_for('movimentos') }}" id="form-filtros">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; align-items: flex-end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="data_inicio">Data In√≠cio:</label>
                    <input type="date" name="data_inicio" id="filter_data_inicio" value="{{ data_inicio or '' }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="data_fim">Data Fim:</label>
                    <input type="date" name="data_fim" id="filter_data_fim" value="{{ data_fim or '' }}">
                </div>
                <button type="submit" class="btn btn-primary">Filtrar</button>
                <a href="{{ url_for('movimentos') }}" class="btn btn-secondary" style="text-align: center;">Limpar Filtro</a>
            </div>
        </form>
        
        <!-- BOT√ïES DE EXPORTA√á√ÉO -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">
                    üì• Exportar Dados
                </h3>
                <span style="font-size: 12px; color: #64748b;">
                    {{ movimentos|length }} movimento(s) encontrado(s)
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <!-- Exportar Movimentos CSV -->
                <button onclick="exportarMovimentos('csv')" class="btn btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìÑ</span>
                    <span>Exportar CSV</span>
                </button>
                
                <!-- Exportar Movimentos Excel -->
                <button onclick="exportarMovimentos('excel')" class="btn btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìä</span>
                    <span>Exportar Excel</span>
                </button>
                
                <!-- Exportar Resumo Mensal -->
                <button onclick="exportarResumo('excel')" class="btn" style="background: #667eea; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìà</span>
                    <span>Resumo Mensal</span>
                </button>
                
                <!-- Exportar Resumo CSV -->
                <button onclick="exportarResumo('csv')" class="btn" style="background: #667eea; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìã</span>
                    <span>Resumo CSV</span>
                </button>
            </div>
            
            <div class="alert alert-info" style="margin-top: 15px; padding: 12px;">
                <strong>‚ÑπÔ∏è Sobre a Exporta√ß√£o:</strong>
                <ul style="margin: 8px 0 0 20px; font-size: 13px;">
                    <li><strong>CSV:</strong> Arquivo de texto com separa√ß√£o por ponto-e-v√≠rgula (;) - ideal para Excel e outras planilhas</li>
                    <li><strong>Excel:</strong> Arquivo .xlsx com formata√ß√£o, cores e f√≥rmulas - pronto para an√°lise</li>
                    <li><strong>Resumo Mensal:</strong> Consolidado por m√™s com receitas, despesas e resultado</li>
                    <li>Os filtros de data aplicados acima ser√£o respeitados na exporta√ß√£o</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- TABELA DE MOVIMENTOS -->
    <div class="card">
        <div class="card-title">Movimentos Lan√ßados</div>
        
        <div class="action-buttons" style="margin-bottom: 1rem;">
            <a href="#" id="btn-editar" class="btn btn-secondary" disabled>Editar</a>
            <button type="submit" form="form-excluir" id="btn-excluir" class="btn btn-danger" disabled>Excluir</button>
        </div>
        <form id="form-excluir" method="POST" action="#" onsubmit="return confirm('Tem certeza?');"></form>

        <div class="table-container">
            <table style="font-size: 0.9em;">
                <thead>
                    <tr>
                        <th style="width: 5%;"></th>
                        <th>Data Mov.</th>
                        <th>Data Efet.</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Conta</th>
                        <th>Cart√£o</th>
                        <th style="text-align: right;">Valor</th>
                        <th>Status</th>
                        <th>Compartilhado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mov in movimentos %}
                    <tr id="row-{{ mov.id }}">
                        <td><input type="radio" name="selecionado" value="{{ mov.id }}" onchange="itemSelecionado(this, 'movimentos')"></td>
                        <td>{{ mov.data_mov_formatada }}</td>
                        <td>{{ mov.data_efet_formatada or '---' }}</td>
                        <td>{{ mov.descricao }}</td>
                        <td>{{ mov.categoria_nome }}</td>
                        <td>{{ mov.instituicao_nome }}</td>
                        <td>{{ mov.cartao_nome or '---' }}</td>
                        <td style="text-align: right; color: {% if mov.categoria_tipo == 'Receita' %}green{% else %}red{% endif %}; font-weight: 600;">
                            {{ format_brl(mov.valor|abs) }}
                        </td>
                        <td>
                            {% if mov.status == 'Efetivado' %}
                                <span class="badge badge-success">Efetivado</span>
                            {% else %}
                                <span class="badge badge-warning">Pendente</span>
                            {% endif %}
                        </td>
                        <td>{{ mov.compartilhado }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                        Nenhum movimento encontrado para o per√≠odo.
                    </td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Fun√ß√£o para exportar movimentos
        function exportarMovimentos(formato) {
            const dataInicio = document.getElementById('filter_data_inicio').value;
            const dataFim = document.getElementById('filter_data_fim').value;
            
            let url = `/movimentos/exportar?formato=${formato}`;
            
            if (dataInicio) {
                url += `&data_inicio=${dataInicio}`;
            }
            
            if (dataFim) {
                url += `&data_fim=${dataFim}`;
            }
            
            // Abre em nova aba para download
            window.location.href = url;
        }
        
        // Fun√ß√£o para exportar resumo mensal
        function exportarResumo(formato) {
            const dataInicio = document.getElementById('filter_data_inicio').value;
            const dataFim = document.getElementById('filter_data_fim').value;
            
            let url = `/movimentos/exportar-resumo?formato=${formato}`;
            
            if (dataInicio) {
                url += `&data_inicio=${dataInicio}`;
            }
            
            if (dataFim) {
                url += `&data_fim=${dataFim}`;
            }
            
            window.location.href = url;
        }
    </script>
{% endblock %}