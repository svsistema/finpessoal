{% extends "base.html" %}

{% block title %}Transfer√™ncias{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Transfer√™ncias e Pagamentos</h1>
        <p>Movimenta√ß√µes entre contas, pagamentos de faturas e aplica√ß√µes</p>
    </div>

    <!-- FORMUL√ÅRIO DE NOVA TRANSFER√äNCIA -->
    <div class="card">
        <div class="card-title">Nova Transfer√™ncia/Pagamento</div>
        
        <form method="POST" action="{{ url_for('add_transferencia') }}">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="data_transferencia">Data da Transfer√™ncia:</label>
                    <input type="date" name="data_transferencia" required>
                </div>
                <div class="form-group">
                    <label for="data_efetivacao">Data de Efetiva√ß√£o (opcional):</label>
                    <input type="date" name="data_efetivacao">
                </div>
            </div>
            
            <div class="form-group">
                <label for="tipo_transferencia">Tipo de Opera√ß√£o:*</label>
                <select name="tipo_transferencia" id="tipo_transferencia" required onchange="alterarTipoTransferencia()">
                    <option value="">-- Selecione --</option>
                    <option value="Entre Contas">Transfer√™ncia Entre Contas</option>
                    <option value="Pagamento Fatura">Pagamento de Fatura de Cart√£o</option>
                    <option value="Para Investimento">Aplica√ß√£o em Investimento</option>
                    <option value="De Investimento">Resgate de Investimento</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="descricao">Descri√ß√£o:</label>
                <input type="text" name="descricao" id="descricao" required autocomplete="off" placeholder="Ex: Transfer√™ncia para poupan√ßa">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="conta_origem_id">Conta de Origem:*</label>
                    <select name="conta_origem_id" required>
                        <option value="">-- Selecione --</option>
                        {% for inst in instituicoes %}
                        <option value="{{ inst.id }}">{{ inst.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" id="div_conta_destino">
                    <label for="conta_destino_id">Conta de Destino:*</label>
                    <select name="conta_destino_id" id="conta_destino_id">
                        <option value="">-- Selecione --</option>
                        {% for inst in instituicoes %}
                        <option value="{{ inst.id }}">{{ inst.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group" id="div_cartao" style="display: none;">
                    <label for="cartao_id">Cart√£o de Cr√©dito:*</label>
                    <select name="cartao_id" id="cartao_id">
                        <option value="">-- Selecione --</option>
                        {% for cartao in cartoes %}
                        <option value="{{ cartao.id }}">{{ cartao.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="valor">Valor (R$):*</label>
                    <input type="number" name="valor" step="0.01" min="0.01" required placeholder="Ex: 500.00">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="status">Status:*</label>
                    <select name="status" required>
                        <option value="Pendente">Pendente</option>
                        <option value="Efetivado">Efetivado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="compartilhado">Compartilhado:*</label>
                    <select name="compartilhado" required>
                        <option value="100% Silvia">100% Silvia</option>
                        <option value="100% Nelson">100% Nelson</option>
                        <option value="50/50">50/50</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Registrar</button>
        </form>
    </div>

    <!-- FILTROS E EXPORTA√á√ÉO -->
    <div class="card">
        <div class="card-title">Filtros e Exporta√ß√£o</div>
        
        <form method="GET" action="{{ url_for('transferencias') }}" id="form-filtros">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; align-items: flex-end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="data_inicio">Data In√≠cio:</label>
                    <input type="date" name="data_inicio" id="filter_data_inicio" value="{{ request.args.get('data_inicio', '') }}">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="data_fim">Data Fim:</label>
                    <input type="date" name="data_fim" id="filter_data_fim" value="{{ request.args.get('data_fim', '') }}">
                </div>
                <button type="submit" class="btn btn-primary">Filtrar</button>
                <a href="{{ url_for('transferencias') }}" class="btn btn-secondary" style="text-align: center;">Limpar Filtro</a>
            </div>
        </form>
        
        <!-- BOT√ïES DE EXPORTA√á√ÉO -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">
                    üì• Exportar Transfer√™ncias
                </h3>
                <span style="font-size: 12px; color: #64748b;">
                    {{ transferencias|length }} transfer√™ncia(s) encontrada(s)
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <!-- Exportar Detalhado CSV -->
                <button onclick="exportarTransferencias('csv')" class="btn btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìÑ</span>
                    <span>Exportar CSV</span>
                </button>
                
                <!-- Exportar Detalhado Excel -->
                <button onclick="exportarTransferencias('excel')" class="btn btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìä</span>
                    <span>Exportar Excel</span>
                </button>
                
                <!-- Exportar Fluxo Excel -->
                <button onclick="exportarFluxo('excel')" class="btn" style="background: #667eea; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üîÑ</span>
                    <span>Fluxo Entre Contas</span>
                </button>
                
                <!-- Exportar Fluxo CSV -->
                <button onclick="exportarFluxo('csv')" class="btn" style="background: #667eea; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">üìã</span>
                    <span>Fluxo CSV</span>
                </button>
            </div>
            
            <div class="alert alert-info" style="margin-top: 15px; padding: 12px;">
                <strong>‚ÑπÔ∏è Sobre a Exporta√ß√£o:</strong>
                <ul style="margin: 8px 0 0 20px; font-size: 13px;">
                    <li><strong>CSV/Excel Detalhado:</strong> Lista completa de todas as transfer√™ncias com origem, destino e valores</li>
                    <li><strong>Fluxo Entre Contas:</strong> Resumo consolidado mostrando quanto foi transferido de cada conta para cada destino</li>
                    <li><strong>Excel Formatado:</strong> Inclui cores por tipo de opera√ß√£o, totalizadores e estat√≠sticas</li>
                    <li>Os filtros de data aplicados acima ser√£o respeitados na exporta√ß√£o</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- TABELA DE TRANSFER√äNCIAS -->
    <div class="card">
        <div class="card-title">Hist√≥rico de Transfer√™ncias e Pagamentos</div>
        
        <div class="action-buttons" style="margin-bottom: 1rem;">
            <a href="#" id="btn-editar" class="btn btn-secondary" disabled>Editar</a>
            <button type="submit" form="form-excluir" id="btn-excluir" class="btn btn-danger" disabled>Excluir</button>
        </div>
        <form id="form-excluir" method="POST" action="#" onsubmit="return confirm('Tem certeza?');"></form>

        <div class="table-container">
            <table style="font-size: 0.9em;">
                <thead>
                    <tr>
                        <th style="width: 5%;"></th>
                        <th>Data</th>
                        <th>Data Efet.</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo</th>
                        <th>Origem</th>
                        <th style="text-align: center;">‚Üí</th>
                        <th>Destino/Cart√£o</th>
                        <th style="text-align: right;">Valor</th>
                        <th>Status</th>
                        <th>Compartilhado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transf in transferencias %}
                    <tr id="row-{{ transf.id }}">
                        <td><input type="radio" name="selecionado" value="{{ transf.id }}" onchange="itemSelecionado(this, 'transferencias')"></td>
                        <td>{{ transf.data_transf_formatada }}</td>
                        <td>{{ transf.data_efet_formatada or '---' }}</td>
                        <td>{{ transf.descricao }}</td>
                        <td>
                            {% if transf.tipo_transferencia == 'Pagamento Fatura' %}
                                <span class="badge badge-warning">Pag. Fatura</span>
                            {% elif transf.tipo_transferencia == 'Para Investimento' %}
                                <span class="badge badge-info">‚Üí Invest.</span>
                            {% elif transf.tipo_transferencia == 'De Investimento' %}
                                <span class="badge badge-success">‚Üê Invest.</span>
                            {% else %}
                                <span class="badge badge-gray">Transfer√™ncia</span>
                            {% endif %}
                        </td>
                        <td>{{ transf.conta_origem_nome }}</td>
                        <td style="text-align: center; color: #667eea; font-weight: bold; font-size: 18px;">‚Üí</td>
                        <td>
                            {% if transf.tipo_transferencia == 'Pagamento Fatura' %}
                                üí≥ {{ transf.cartao_nome }}
                            {% else %}
                                {{ transf.conta_destino_nome }}
                            {% endif %}
                        </td>
                        <td style="text-align: right; color: #667eea; font-weight: bold;">
                            {{ format_brl(transf.valor) }}
                        </td>
                        <td>
                            {% if transf.status == 'Efetivado' %}
                                <span class="badge badge-success">Efetivado</span>
                            {% else %}
                                <span class="badge badge-warning">Pendente</span>
                            {% endif %}
                        </td>
                        <td>{{ transf.compartilhado }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="11" style="text-align: center; padding: 40px; color: #64748b;">
                        Nenhuma transfer√™ncia registrada.
                    </td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="alert alert-info">
        <strong>‚ÑπÔ∏è Importante:</strong> 
        <ul style="margin: 10px 0 0 20px;">
            <li><strong>Transfer√™ncias:</strong> N√£o afetam receitas/despesas, apenas movimentam entre contas</li>
            <li><strong>Pagamento de Fatura:</strong> Reduz o saldo banc√°rio mas N√ÉO conta como despesa (as compras j√° foram registradas)</li>
            <li><strong>Investimentos:</strong> Registre aqui a movimenta√ß√£o e depois lance a opera√ß√£o em "Lan√ßar Invest."</li>
            <li><strong>Exporta√ß√£o:</strong> Use os bot√µes acima para gerar relat√≥rios completos das transfer√™ncias</li>
        </ul>
    </div>

    <script>
        function alterarTipoTransferencia() {
            const tipo = document.getElementById('tipo_transferencia').value;
            const divContaDestino = document.getElementById('div_conta_destino');
            const divCartao = document.getElementById('div_cartao');
            const contaDestinoSelect = document.getElementById('conta_destino_id');
            const cartaoSelect = document.getElementById('cartao_id');
            const descricao = document.getElementById('descricao');
            
            // Reset
            contaDestinoSelect.removeAttribute('required');
            cartaoSelect.removeAttribute('required');
            
            if (tipo === 'Pagamento Fatura') {
                // Mostra campo de cart√£o, esconde conta destino
                divContaDestino.style.display = 'none';
                divCartao.style.display = 'block';
                cartaoSelect.setAttribute('required', 'required');
                descricao.value = 'Pagamento de fatura';
            } else {
                // Mostra conta destino, esconde cart√£o
                divContaDestino.style.display = 'block';
                divCartao.style.display = 'none';
                contaDestinoSelect.setAttribute('required', 'required');
                
                if (tipo === 'Para Investimento') {
                    descricao.value = 'Transfer√™ncia para investimento';
                } else if (tipo === 'De Investimento') {
                    descricao.value = 'Resgate de investimento';
                } else if (tipo === 'Entre Contas') {
                    descricao.value = 'Transfer√™ncia entre contas';
                }
            }
        }
        
        // Fun√ß√£o para exportar transfer√™ncias detalhadas
        function exportarTransferencias(formato) {
            const dataInicio = document.getElementById('filter_data_inicio').value;
            const dataFim = document.getElementById('filter_data_fim').value;
            
            let url = `/transferencias/exportar?formato=${formato}`;
            
            if (dataInicio) {
                url += `&data_inicio=${dataInicio}`;
            }
            
            if (dataFim) {
                url += `&data_fim=${dataFim}`;
            }
            
            // Abre em nova aba para download
            window.location.href = url;
        }
        
        // Fun√ß√£o para exportar fluxo entre contas
        function exportarFluxo(formato) {
            const dataInicio = document.getElementById('filter_data_inicio').value;
            const dataFim = document.getElementById('filter_data_fim').value;
            
            let url = `/transferencias/exportar-fluxo?formato=${formato}`;
            
            if (dataInicio) {
                url += `&data_inicio=${dataInicio}`;
            }
            
            if (dataFim) {
                url += `&data_fim=${dataFim}`;
            }
            
            window.location.href = url;
        }
    </script>
{% endblock %}