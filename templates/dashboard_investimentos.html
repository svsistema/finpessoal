{% extends "base_novo.html" %}

{% block title %}Dashboard de Investimentos{% endblock %}

{% block content %}
<div class="page-header">
    <div class="breadcrumb">
        <a href="{{ url_for('dashboard') }}">📊 Dashboard</a> / <span>Investimentos</span>
    </div>
    <h1>Dashboard de Investimentos</h1>
    <p>Análise completa da sua carteira de investimentos</p>
</div>

<!-- KPIs DE INVESTIMENTOS -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">PATRIMÔNIO INVESTIDO</div>
                <div style="font-size: 32px; font-weight: 700; margin-bottom: 8px;">{{ patrimonio_total }}</div>
                <div style="font-size: 13px; opacity: 0.9;">
                    Valor atual: {{ valor_atual_total }}
                </div>
            </div>
            <div style="font-size: 40px; opacity: 0.3;">💰</div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 600;">RENTABILIDADE TOTAL</div>
                <div style="font-size: 32px; font-weight: 700; color: {% if rentabilidade_total_num >= 0 %}#10b981{% else %}#ef4444{% endif %}; margin-bottom: 8px;">
                    {{ rentabilidade_total }}
                </div>
                <div style="font-size: 13px; color: #64748b;">Acumulado</div>
            </div>
            <div style="font-size: 40px; opacity: 0.2;">📈</div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 600;">DIVIDENDOS RECEBIDOS</div>
                <div style="font-size: 32px; font-weight: 700; color: #667eea; margin-bottom: 8px;">{{ dividendos_total }}</div>
                <div style="font-size: 13px; color: #64748b;">Últimos 12 meses</div>
            </div>
            <div style="font-size: 40px; opacity: 0.2;">💵</div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 600;">NÚMERO DE ATIVOS</div>
                <div style="font-size: 32px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">{{ num_ativos }}</div>
                <div style="font-size: 13px; color: #64748b;">
                    {% if num_ativos >= 10 %}Diversificação: Boa{% elif num_ativos >= 5 %}Diversificação: Média{% else %}Diversificação: Baixa{% endif %}
                </div>
            </div>
            <div style="font-size: 40px; opacity: 0.2;">📊</div>
        </div>
    </div>
</div>

<!-- ALERTAS -->
{% if num_ativos == 0 %}
<div class="alert alert-info" style="margin-bottom: 30px;">
    <strong>📊 Comece a Investir:</strong> Você ainda não tem investimentos cadastrados. Vá em "Investimentos > Operações" para adicionar seus primeiros ativos!
</div>
{% else %}
<div class="alert alert-info" style="margin-bottom: 30px;">
    <strong>💡 Dica de Investimentos:</strong> 
    {% if num_ativos >= 10 %}
        Sua carteira está bem diversificada! Continue investindo mensalmente para aproveitar o poder dos juros compostos.
    {% elif num_ativos >= 5 %}
        Considere aumentar a diversificação adicionando mais ativos à sua carteira.
    {% else %}
        Sua carteira tem poucos ativos. Considere diversificar mais para reduzir riscos.
    {% endif %}
</div>
{% endif %}

<!-- GRÁFICOS DE INVESTIMENTOS -->
{% if num_ativos > 0 %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Alocação de Carteira -->
    <div class="card">
        <div class="card-title">Alocação de Carteira por Classe</div>
        <div style="position: relative; height:300px; width:100%">
            <canvas id="alocacaoChart" height="300"></canvas>
        </div>
    </div>

    <!-- Evolução do Patrimônio -->
    <div class="card">
        <div class="card-title">Evolução do Patrimônio Investido</div>
        {% if evolucao_labels %}
        <div style="position: relative; height:300px; width:100%">
        <canvas id="evolucaoInvestChart" height="300"></canvas>
        {% else %}
        <p style="text-align: center; color: #64748b; padding: 60px;">Adicione mais investimentos para ver a evolução ao longo do tempo.</p>
        {% endif %}
        </div>
    </div>

    <!-- Rentabilidade por Ativo -->
    <div class="card">
        <div class="card-title">Top 5 Ativos - Rentabilidade</div>
        {% if top_5_labels %}
        <div style="position: relative; height:300px; width:100%">
            <canvas id="rentabilidadeChart" height="300"></canvas>
        {% else %}
        <p style="text-align: center; color: #64748b; padding: 60px;">Nenhum ativo encontrado.</p>
        {% endif %}
        </div>
    </div>

    <!-- Dividendos Mensais -->
    <div class="card">
        <div class="card-title">Dividendos Recebidos (Últimos 6 Meses)</div>
        {% if dividendos_labels %}
            <canvas id="dividendosChart" height="300"></canvas>
        {% else %}
        <p style="text-align: center; color: #64748b; padding: 60px;">
            Nenhum dividendo registrado. Cadastre operações do tipo "Dividendo" para acompanhar seus rendimentos.
        </p>
        {% endif %}
    </div>
</div>

<!-- TABELA DE POSIÇÕES -->
<div class="card">
    <div class="card-title">Posição Atual - Carteira de Investimentos</div>
    {% if tabela_posicoes %}
    <table>
        <thead>
            <tr>
                <th>Ativo</th>
                <th>Classe</th>
                <th style="text-align: right;">Quantidade</th>
                <th style="text-align: right;">Preço Médio</th>
                <th style="text-align: right;">Valor Investido</th>
                <th style="text-align: right;">Valor Atual</th>
                <th style="text-align: right;">Rentabilidade</th>
                <th style="text-align: right;">% Carteira</th>
            </tr>
        </thead>
        <tbody>
            {% for pos in tabela_posicoes %}
            <tr>
                <td><strong>{{ pos.ticker }}</strong></td>
                <td>{{ pos.classe }}</td>
                <td style="text-align: right;">{{ pos.quantidade }}</td>
                <td style="text-align: right;">{{ pos.preco_medio }}</td>
                <td style="text-align: right;">{{ pos.valor_investido }}</td>
                <td style="text-align: right;">{{ pos.valor_atual }}</td>
                <td style="text-align: right;">
                    <span class="badge {% if pos.rentabilidade_num >= 0 %}badge-success{% else %}badge-danger{% endif %}">
                        {% if pos.rentabilidade_num >= 0 %}+{% endif %}{{ pos.rentabilidade }}
                    </span>
                </td>
                <td style="text-align: right;">{{ pos.percentual_carteira }}</td>
            </tr>
            {% endfor %}
            <tr style="background: #f8fafc; font-weight: 600;">
                <td colspan="4"><strong>TOTAL</strong></td>
                <td style="text-align: right;"><strong>{{ patrimonio_total }}</strong></td>
                <td style="text-align: right;"><strong>{{ valor_atual_total }}</strong></td>
                <td style="text-align: right;">
                    <span class="badge {% if rentabilidade_total_num >= 0 %}badge-success{% else %}badge-danger{% endif %}">
                        {% if rentabilidade_total_num >= 0 %}+{% endif %}{{ rentabilidade_total }}
                    </span>
                </td>
                <td style="text-align: right;"><strong>100%</strong></td>
            </tr>
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #64748b; padding: 40px;">
        Nenhum ativo na carteira. Comece adicionando investimentos!
    </p>
    {% endif %}
</div>

<!-- COMPARAÇÃO COM BENCHMARKS -->
<div class="card" style="margin-top: 30px;">
    <div class="card-title">Comparação com Benchmarks (12 meses)</div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="text-align: center; padding: 20px; background: {% if rentabilidade_total_num >= 0 %}#f0fdf4{% else %}#fef2f2{% endif %}; border-radius: 8px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">Sua Carteira</div>
            <div style="font-size: 28px; font-weight: 700; color: {% if rentabilidade_total_num >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                {{ rentabilidade_total }}
            </div>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">CDI</div>
            <div style="font-size: 28px; font-weight: 700; color: #64748b;">{{ cdi_12m }}%</div>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">IPCA</div>
            <div style="font-size: 28px; font-weight: 700; color: #64748b;">{{ ipca_12m }}%</div>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">Ibovespa</div>
            <div style="font-size: 28px; font-weight: 700; color: #64748b;">{{ ibov_12m }}%</div>
        </div>
    </div>
    {% if rentabilidade_total_num > cdi_12m %}
    <div class="alert alert-success" style="margin-top: 20px;">
        <strong>🎉 Parabéns!</strong> Sua carteira está rendendo acima do CDI (+{{ "%.2f"|format(vs_cdi) }} p.p.){% if rentabilidade_total_num > ibov_12m %} e do Ibovespa (+{{ "%.2f"|format(vs_ibov) }} p.p.){% endif %}!
    </div>
    {% elif rentabilidade_total_num > 0 %}
    <div class="alert alert-info" style="margin-top: 20px;">
        <strong>📊 Análise:</strong> Sua carteira está com rentabilidade positiva, mas abaixo do CDI ({{ "%.2f"|format(vs_cdi) }} p.p.). Considere revisar sua estratégia de alocação.
    </div>
    {% else %}
    <div class="alert alert-warning" style="margin-top: 20px;">
        <strong>⚠️ Atenção:</strong> Sua carteira está com rentabilidade negativa. Analise seus ativos e considere rebalancear sua carteira.
    </div>
    {% endif %}
</div>

<div class="alert alert-info" style="margin-top: 30px;">
    <strong>ℹ️ Nota:</strong> Os valores de rentabilidade são estimados com base nos dados cadastrados. Para valores precisos, considere atualizar os preços atuais dos ativos ou integrar com uma API de cotações.
</div>

{% else %}
<div class="card">
    <div style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 20px;">📊</div>
        <h3 style="color: #1e293b; margin-bottom: 10px;">Comece a Investir!</h3>
        <p style="color: #64748b; margin-bottom: 30px;">
            Você ainda não tem investimentos cadastrados no sistema.
        </p>
        <a href="{{ url_for('investimentos') }}" class="btn btn-primary">
            Cadastrar Primeiro Investimento
        </a>
    </div>
</div>
{% endif %}

<script>
{% if num_ativos > 0 %}
// Alocação por Classe
const ctx1 = document.getElementById('alocacaoChart').getContext('2d');
new Chart(ctx1, {
    type: 'doughnut',
    data: {
        labels: {{ alocacao_labels|tojson }},
        datasets: [{
            data: {{ alocacao_valores|tojson }},
            backgroundColor: ['#667eea', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' }
        }
    }
});

{% if evolucao_labels %}
// Evolução do Patrimônio
const ctx2 = document.getElementById('evolucaoInvestChart').getContext('2d');
new Chart(ctx2, {
    type: 'line',
    data: {
        labels: {{ evolucao_labels|tojson }},
        datasets: [{
            label: 'Patrimônio',
            data: {{ evolucao_valores|tojson }},
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
    }
});
{% endif %}

{% if top_5_labels %}
// Rentabilidade por Ativo
const ctx3 = document.getElementById('rentabilidadeChart').getContext('2d');
new Chart(ctx3, {
    type: 'bar',
    data: {
        labels: {{ top_5_labels|tojson }},
        datasets: [{
            label: 'Rentabilidade (%)',
            data: {{ top_5_valores|tojson }},
            backgroundColor: function(context) {
                const value = context.parsed.y;
                return value >= 0 ? '#10b981' : '#ef4444';
            }
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { legend: { display: false } }
    }
});
{% endif %}

{% if dividendos_labels %}
// Dividendos
const ctx4 = document.getElementById('dividendosChart').getContext('2d');
new Chart(ctx4, {
    type: 'bar',
    data: {
        labels: {{ dividendos_labels|tojson }},
        datasets: [{
            label: 'Dividendos (R$)',
            data: {{ dividendos_valores|tojson }},
            backgroundColor: '#667eea'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
    }
});
{% endif %}
{% endif %}
</script>

{% endblock %}